#!/usr/bin/env python
# -*- coding: utf-8 -*-
import numpy as np
from numpy import log, exp
from math import sqrt, sin, cos
from controller_functions import adj_calc

def PCC_jacobian(q,d,L0,qd):

    dx = q[0][0]
    dy = q[1][0]
    dL = q[2][0]
    dx_dot = qd[0][0]
    dy_dot = qd[1][0]
    dL_dot = qd[2][0]
    delt = sqrt(dx**2 + dy**2)

    if (delt < 10**-6):
        T_q = np.zeros((4, 4))
        T_q[:3, :3] = np.identity(3)
        T_q[:3, 3] = np.array([0, 0, L0+dL]).reshape(-1, 1)[:,0]
        T_q[3, :] = np.array([0, 0, 0, 1])
        J = np.array([[(L0 + dL)/(2*d), 0, 0],
                        [0, (L0 + dL)/(2*d), 0],
                        [0,               0, 1],
                        [0,            -1/d, 0],
                        [1/d,               0, 0],
                        [0,               0, 0]])
        dJ = np.array([[              dL_dot/(2*d),                               0, -dx_dot/(2*d)],
                        [            0,                    dL_dot/(2*d), -dy_dot/(2*d)],
            [(dx_dot*(L0 + dL))/(6*d**2), (L0*dy_dot + dL*dy_dot)/(6*d**2),             0],
                                    [0,                               0,             0],
                                    [0,                               0,             0],
                        [dy_dot/(2*d**2),                 -dx_dot/(2*d**2),             0]])
    else:
        
        Rq = np.array([[1 + dx**2/delt**2*(cos(delt/d) - 1), dx*dy/delt**2*(cos(delt/d) - 1), -dx/delt*sin(delt/d)],
        [dx*dy/delt**2*(cos(delt/d) - 1), 1+dy**2/delt**2*(cos(delt/d) - 1), -dy/delt*sin(delt/d)],
        [dx/delt*sin(delt/d), dy/delt*sin(delt/d), cos(delt/d)]]).T

        tq = d*(L0 + dL)/delt**2*np.array([dx*(1 - cos(delt/d)), dy*(1 - cos(delt/d)), delt*sin(delt/d)]).reshape(-1,1)
        T_q = np.zeros((4, 4))
        T_q[:3, :3] = Rq
        T_q[:3, 3] = tq[:,0]
        T_q[3, :] = np.array([0, 0, 0, 1])
        J = np.array([[((dy**2 + dx**2*cos((dx**2 + dy**2)**(1/2)/d))*((dx**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL))/(dx**2 + dy**2)**(3/2) - (d*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) + (2*d*dx**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2))/(dx**2 + dy**2) - (dx**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**2 + (dx**2*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**3,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                0, (d*dx*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  [            0, ((dx**2 + dy**2*cos((dx**2 + dy**2)**(1/2)/d))*((dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL))/(dx**2 + dy**2)**(3/2) - (d*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) + (2*d*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2))/(dx**2 + dy**2) - (dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**2 + (dx**2*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**3, (d*dy*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                            [(dx*(L0 + dL)*((dx**2 + dy**2)**(3/2) - d*sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)))/(dx**2 + dy**2)**(5/2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                            (dy*(L0 + dL)*((dx**2 + dy**2)**(3/2) - d*sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)))/(dx**2 + dy**2)**(5/2),    (d*sin((dx**2 + dy**2)**(1/2)/d))/(dx**2 + dy**2)**(1/2)],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           [ -(dx*dy*((dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(d*(dx**2 + dy**2)**(3/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          -(dy**2*(dx**2 + dy**2)**(1/2) + d*dx**2*sin((dx**2 + dy**2)**(1/2)/d))/(d*(dx**2 + dy**2)**(3/2)),                                                     0],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            [(dx**2*(dx**2 + dy**2)**(1/2) + d*dy**2*sin((dx**2 + dy**2)**(1/2)/d))/(d*(dx**2 + dy**2)**(3/2)),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             (dx*dy*((dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(d*(dx**2 + dy**2)**(3/2)),                                                     0],
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               [-(dy*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              (dx*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2),                                                     0]])
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
   
   
   
   
   
    # %     J = [                                                       -(d*(L0 + dL)*(cos(delt/d)*dx**2 + dy**2)*(cos(delt/d) - 1))/delt**4,                                                -(d*dx*dy*(L0 + dL)*(cos(delt/d) - 1)**2)/delt**4, - (d*dx*sin(delt/d)**2)/delt**2 - (d*dx*dy**2*(cos(delt/d) - 1)**2)/delt**4 - (d*dx*(cos(delt/d)*dx**2 + dy**2)*(cos(delt/d) - 1))/delt**4;
    # %                                                                                 -(d*dx*dy*(L0 + dL)*(cos(delt/d) - 1)**2)/delt**4,                               -(d*(L0 + dL)*(dx**2 + cos(delt/d)*dy**2)*(cos(delt/d) - 1))/delt**4,   (d*dy*sin(delt/d)**2)/delt**2 - (d*dx**2*dy*(cos(delt/d) - 1)**2)/delt**4 - (d*dy*(dx**2 + cos(delt/d)*dy**2)*(cos(delt/d) - 1))/delt**4;
    # %                                                                           -(d*dx*sin(delt/d)*(L0 + dL)*(cos(delt/d) - 1))/delt**3,                                           (d*dy*sin(delt/d)*(L0 + dL)*(cos(delt/d) - 1))/delt**3,                                   (d*sin(delt/d)*(delt**2*cos(delt/d) - dx**2*cos(delt/d) + dy**2*cos(delt/d) + dx**2 - dy**2))/delt**3;
    # %                                                                                     (dx*dy*sin(delt/d)*(cos(delt/d) - 1))/delt**3, -(sin(delt/d)*(delt**2*cos(delt/d) - dx**2*cos(delt/d) + 2*dy**2*cos(delt/d) + dx**2 - 2*dy**2))/delt**3,                                                                                                                           0;
    # %                                                                                   (sin(delt/d)*(cos(delt/d)*dx**2 + dy**2))/delt**3,                                                    (dx*dy*sin(delt/d)*(cos(delt/d) - 1))/delt**3,                                                                                                                           0;
    # %         (dy*(dx**2 + cos(delt/d)*dy**2)*(cos(delt/d) - 1))/delt**4 - (dy*sin(delt/d)**2)/delt**2 + (2*dx**2*dy*(cos(delt/d) - 1)**2)/delt**4,                                         (dx*(dx**2 + cos(delt/d)*dy**2)*(cos(delt/d) - 1))/delt**4,                                                                                                                           0];
        dJ = np.array([[((dy**2 + dx**2*cos((dx**2 + dy**2)**(1/2)/d))*((sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(3/2)) - (d*dL_dot*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) + (dL_dot*dx**2*sin((dx**2 + dy**2)**(1/2)/d))/(dx**2 + dy**2)**(3/2) - (5*dx**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(5/2)) + (2*dx*dx_dot*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL))/(dx**2 + dy**2)**(3/2) + (2*d*dL_dot*dx**2*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2 + (d*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**2 + (4*d*dx*dx_dot*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2 - (4*d*dx**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**3 + (dx**2*cos((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**2)))/(dx**2 + dy**2) + (((dx**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL))/(dx**2 + dy**2)**(3/2) - (d*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) + (2*d*dx**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2)*(2*dy*dy_dot + 2*dx*dx_dot*cos((dx**2 + dy**2)**(1/2)/d) - (dx**2*sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(1/2))))/(dx**2 + dy**2) - ((dy**2 + dx**2*cos((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot)*((dx**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL))/(dx**2 + dy**2)**(3/2) - (d*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) + (2*d*dx**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2))/(dx**2 + dy**2)**2 - (dL_dot*dx**2*sin((dx**2 + dy**2)**(1/2)/d)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**2 + (dx**2*sin((dx**2 + dy**2)**(1/2)/d)**2*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**2) + (2*dx**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**3 - (dx**2*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*((sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(1/2)) - (cos((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d)))/(dx**2 + dy**2)**3 - (2*dx*dx_dot*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**2 + (dL_dot*dx**2*dy**2*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**3 - (dx**2*cos((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(5/2)) - (3*dx**2*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**4 + (2*dx*dx_dot*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**3 + (2*dx**2*dy*dy_dot*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**3 - (dx**2*dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(2*d*(dx**2 + dy**2)**(7/2)), 0, (d*dx_dot*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) - (dx*sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(3/2)) - (d*dx*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**2],
            [0, ((dx**2 + dy**2*cos((dx**2 + dy**2)**(1/2)/d))*((sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(3/2)) - (d*dL_dot*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) + (dL_dot*dy**2*sin((dx**2 + dy**2)**(1/2)/d))/(dx**2 + dy**2)**(3/2) - (5*dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(5/2)) + (2*dy*dy_dot*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL))/(dx**2 + dy**2)**(3/2) + (2*d*dL_dot*dy**2*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2 + (d*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**2 + (4*d*dy*dy_dot*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2 - (4*d*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**3 + (dy**2*cos((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**2)))/(dx**2 + dy**2) + (((dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL))/(dx**2 + dy**2)**(3/2) - (d*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) + (2*d*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2)*(2*dx*dx_dot + 2*dy*dy_dot*cos((dx**2 + dy**2)**(1/2)/d) - (dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(1/2))))/(dx**2 + dy**2) - ((dx**2 + dy**2*cos((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot)*((dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL))/(dx**2 + dy**2)**(3/2) - (d*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) + (2*d*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2)**2))/(dx**2 + dy**2)**2 - (dL_dot*dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**2 + (dy**2*sin((dx**2 + dy**2)**(1/2)/d)**2*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**2) + (2*dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**3 - (dx**2*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*((sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(1/2)) - (cos((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d)))/(dx**2 + dy**2)**3 - (2*dy*dy_dot*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**2 + (dL_dot*dx**2*dy**2*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**3 - (dy**2*cos((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(5/2)) - (3*dx**2*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**4 + (2*dx*dx_dot*dy**2*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**3 + (2*dx**2*dy*dy_dot*(L0 + dL)*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(dx**2 + dy**2)**3 - (dx**2*dy**2*sin((dx**2 + dy**2)**(1/2)/d)*(L0 + dL)*(2*dx*dx_dot + 2*dy*dy_dot)*(sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)**(1/2) - 2*d + 2*d*cos((dx**2 + dy**2)**(1/2)/d)))/(2*d*(dx**2 + dy**2)**(7/2)), (d*dy_dot*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) - (dy*sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(3/2)) - (d*dy*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**2],
              [(dx_dot*(L0 + dL)*((dx**2 + dy**2)**(3/2) - d*sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)))/(dx**2 + dy**2)**(5/2) - (dx*(L0 + dL)*((cos((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot)*(dx**2 + dy**2)**(1/2))/2 - (3*(2*dx*dx_dot + 2*dy*dy_dot)*(dx**2 + dy**2)**(1/2))/2 + d*sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot)))/(dx**2 + dy**2)**(5/2) + (dL_dot*dx*((dx**2 + dy**2)**(3/2) - d*sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)))/(dx**2 + dy**2)**(5/2) - (5*dx*(L0 + dL)*((dx**2 + dy**2)**(3/2) - d*sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2))*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(7/2)), (dy_dot*(L0 + dL)*((dx**2 + dy**2)**(3/2) - d*sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)))/(dx**2 + dy**2)**(5/2) - (dy*(L0 + dL)*((cos((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot)*(dx**2 + dy**2)**(1/2))/2 - (3*(2*dx*dx_dot + 2*dy*dy_dot)*(dx**2 + dy**2)**(1/2))/2 + d*sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot)))/(dx**2 + dy**2)**(5/2) + (dL_dot*dy*((dx**2 + dy**2)**(3/2) - d*sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2)))/(dx**2 + dy**2)**(5/2) - (5*dy*(L0 + dL)*((dx**2 + dy**2)**(3/2) - d*sin((dx**2 + dy**2)**(1/2)/d)*(dx**2 + dy**2))*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(7/2)), (cos((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)) - (d*sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(3/2))],
        [(3*dx*dy*((dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(5/2)) - (dx*dy_dot*((dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(d*(dx**2 + dy**2)**(3/2)) - (dx_dot*dy*((dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(d*(dx**2 + dy**2)**(3/2)) - (dx*dy*((2*dx*dx_dot + 2*dy*dy_dot)/(2*(dx**2 + dy**2)**(1/2)) - (cos((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(1/2))))/(d*(dx**2 + dy**2)**(3/2)), (3*(dy**2*(dx**2 + dy**2)**(1/2) + d*dx**2*sin((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(5/2)) - ((dy**2*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(1/2)) + 2*dy*dy_dot*(dx**2 + dy**2)**(1/2) + 2*d*dx*dx_dot*sin((dx**2 + dy**2)**(1/2)/d) + (dx**2*cos((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(1/2)))/(d*(dx**2 + dy**2)**(3/2)), 0],
        [((dx**2*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(1/2)) + 2*dx*dx_dot*(dx**2 + dy**2)**(1/2) + 2*d*dy*dy_dot*sin((dx**2 + dy**2)**(1/2)/d) + (dy**2*cos((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(1/2)))/(d*(dx**2 + dy**2)**(3/2)) - (3*(dx**2*(dx**2 + dy**2)**(1/2) + d*dy**2*sin((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(5/2)), (dx*dy*((2*dx*dx_dot + 2*dy*dy_dot)/(2*(dx**2 + dy**2)**(1/2)) - (cos((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*(dx**2 + dy**2)**(1/2))))/(d*(dx**2 + dy**2)**(3/2)) + (dx*dy_dot*((dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(d*(dx**2 + dy**2)**(3/2)) + (dx_dot*dy*((dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d)))/(d*(dx**2 + dy**2)**(3/2)) - (3*dx*dy*((dx**2 + dy**2)**(1/2) - d*sin((dx**2 + dy**2)**(1/2)/d))*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(5/2)), 0],
        [(dy*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**2 - (dy_dot*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) + (dy*sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(3/2)), (dx_dot*(cos((dx**2 + dy**2)**(1/2)/d) - 1))/(dx**2 + dy**2) - (dx*(cos((dx**2 + dy**2)**(1/2)/d) - 1)*(2*dx*dx_dot + 2*dy*dy_dot))/(dx**2 + dy**2)**2 - (dx*sin((dx**2 + dy**2)**(1/2)/d)*(2*dx*dx_dot + 2*dy*dy_dot))/(2*d*(dx**2 + dy**2)**(3/2)), 0]])

    X = adj_calc(T_q,1)
    return X, J, T_q, dJ                            